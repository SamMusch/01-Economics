---
title: "Global Economics"
author: "Sam Musch - musch.sam@gmail.com"
subtitle: ''
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
  #rmdformats::robobook:
    #toc: yes
    #toc_depth: '4'
    #df_print: paged
urlcolor: blue
---

---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=5, fig.height=3, fig.align='left', warning=F, message=F)
kable_func <- function(data) {
  knitr::kable(data, booktabs=T, digits=2) %>%
    kable_styling(latex_options = c('striped', 'scale_down'))
}
theme_ilo <- function() {
  theme_minimal() +
    theme(
      text = element_text(family = "Bookman", color = "gray25"),
      plot.subtitle = element_text(size = 10),
      plot.caption = element_text(color = "gray30"),
      plot.background = element_rect(fill = "gray95"),
      plot.margin = unit(c(5, 10, 5, 10), units = "mm")
    )
}
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

```


```{r}
library(tidyverse)
library(DT)
library(RCurl)
library(lubridate)
library(Quandl)

start <- '2021-04-01'
end <- '2021-08-01'
```



International Trade

- Trade


US Core

- GDP: Bureau of Economic Analysis
- Inflation: Bureau of Labor Statistics
- Unemployment: Bureau of Labor Statistics
- Monetary: Federal Open Market Committee (FRED, Fed Reserve Economic Data), 8 meetings per year


Short term

- Consumer Confidence: Conference Board
- Index of Leading Indicators: Conference Board
- Business Cycles: National Bureau of Economic Research


Science

- Resources
- Energy
- NASA


Others

- US Census
- Energy
- Google Earth



# International

## Trade

```{r}
library(tradestatistics)
# datatable(ots_tables)
# part of "ropensci"
# https://tradestatistics.io/
# https://docs.ropensci.org/tradestatistics/reference/index.html

import_size_2020 <- ots_create_tidy_data(
  years = 2020,
  reporters = c("usa"),
  #partners = "arg",
  table = "yrp"
) %>% 
  mutate(totals = sum(trade_value_usd_imp),
         pct_total = formatC(100 * trade_value_usd_imp / totals), digits=2) %>%
  select(partner_iso, trade_value_usd_imp, pct_total) %>%
  arrange(desc(trade_value_usd_imp)) 


ots_countries

```





```{r}

# Sept 10: 5 major trade partners of the US

us_only <- ots_create_tidy_data(
  years = 2000:2020,
  reporters = c("usa"),
  table = "yr") %>%
  select(-reporter_fullname_english) %>%
  rename(us_total_exp = trade_value_usd_exp,
         us_total_imp = trade_value_usd_imp)

can_chn_mex <- ots_create_tidy_data(
  years = 2000:2020,
  reporters = c("usa"),
  partners = c("can", "chn", "mex","gbr", "jpn"),
  table = "yrp") %>%
  select(-reporter_fullname_english, -partner_iso) 


agg_df <- us_only %>% 
  inner_join(can_chn_mex,
            by = c('year', 'reporter_iso')) %>%
  mutate(exp_pct = trade_value_usd_exp / us_total_exp,
         imp_pct = trade_value_usd_imp / us_total_imp) %>%
  select(year, partner_fullname_english, exp_pct, imp_pct) %>% 
  pivot_longer(cols = c('exp_pct', 'imp_pct'),
               names_to = 'var_name') %>% 
  mutate(rep_year = lubridate::ymd(year, truncated = 2L))


ggplot(agg_df, aes(x = rep_year, y = value, color = partner_fullname_english)) +
  geom_line() +
  facet_grid(cols = vars(var_name)) +
  theme_bw()



```




---

```{r, eval=FALSE}
data_first <- ots_create_tidy_data(
  years = c(2015, 2020),
  reporters = c("usa"),
  table = "yrp")

data <- data_first %>% 
  select(year, partner_iso, trade_value_usd_imp) %>%
  dplyr::mutate(trade_value_usd_imp = replace_na(trade_value_usd_imp, 0)) %>%
  drop_na() %>%
  group_by(year) %>%
  arrange(desc(trade_value_usd_imp)) %>%
  mutate(rank=row_number()) %>%
  filter(rank<=25) %>% 
  mutate(year = lubridate::ymd(year, truncated = 2L)) %>%
  as_tibble()

data %>% 
  arrange(partner_iso, year) %>%
  group_by(partner_iso) %>%
  mutate(pct_change = (trade_value_usd_imp / lag(trade_value_usd_imp) - 1) * 100) %>%
  arrange(desc(pct_change))
  #ungroup() %>%
  #filter(year == '2020-01-01')


```



---

# US Core

```{r}
# https://urbaninstitute.github.io/urbnmapr/articles/introducing-urbnmapr.html
library(urbnmapr) # US
states %>% select(long, lat, state_abbv) %>% head()

```

---

## GDP

- [Github Repo](https://github.com/us-bea/bea.R)
- [NIPA Tables](https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey)


```{r gdp}
#library(devtools)
#install_github('mikeasilva/blsAPI')

library(bea.R)
library(tidyverse)
#tables <- beaSearch('gross domestic', beaKey)
# tables %>% mutate(ReleaseDate = mdy_hm(ReleaseDate))
beaKey <- Sys.getenv("beaKey")

year_list = c("2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021")
gdp_real <- list(
  "UserID" = beaKey,
  "Method" = "GetData",
  "datasetname" = "NIPA",
  "TableName" = "T10103", 
  'Frequency' = 'Q',
  "LineCode" = 1,
  "GeoFips" = "National",
  "Year" = year_list)
gdp_real <- beaGet(gdp_real, asWide = FALSE) %>%
  select(LineDescription, TimePeriod, DataValue)


gdp_real_growth <- list(
  "UserID" = beaKey,
  "Method" = "GetData",
  "datasetname" = "NIPA",
  "TableName" = "T10101", 
  'Frequency' = 'Q',
  "LineCode" = 1,
  "GeoFips" = "National",
  "Year" = year_list)
gdp_real_growth <- beaGet(gdp_real_growth, asWide = FALSE) %>%
  select(LineDescription, TimePeriod, DataValue)


```

---

## Inflation


https://github.com/mikeasilva/blsAPI

https://www.bls.gov/developers/api_r.htm


```{r}
library(rjson)
library(blsAPI)
response <- blsAPI('CUSR0000SA0') # All items in U.S. city average, all urban consumers, seasonally adjusted
                                  # https://download.bls.gov/pub/time.series/cu/cu.series

# https://download.bls.gov/pub/time.series/ap/

# Functions comes from github link
json <- fromJSON(response)
apiDF <- function(data){
  df <- data.frame(year=character(),
                   period=character(),
                   periodName=character(),
                   value=character(),
                   stringsAsFactors=FALSE)
  i <- 0
  for(d in data){
    i <- i + 1
    df[i,] <- unlist(d)
  }
  return(df)}


cpi <- apiDF(json$Results$series[[1]]$data)
cpi %>% head()
```

---

## Employment

Clothing - https://www.bls.gov/iag/tgs/iag448.htm

```{r employment}
library(blsAPI)
#https://www.bls.gov/data/



```

---

## Monetary


```{r}
library(fredr)
Sys.getenv("FRED_API_KEY")


#m1 <- Quandl('FRED/M1SL', start_date=start, end_date=end)


```

```{r}
housing <- fredr_series_search_text(
  search_text = "duluth housing cbsa",
  order_by = 'title',
  limit = 1000L) %>% filter(frequency_short == 'M', units != 'Percent')
```


---

# Short-Term

## Consumer Confidence

```{r}

cons_conf <- Quandl('OECD/KEI_CSCICP02_USA_ST_M', start_date=start, end_date=end)

```




# Others

---

## US Census

```{r}
library(tidycensus)  # https://walker-data.com/tidycensus/articles/basic-usage.html
library(censusapi)   # main one to use
  # https://github.com/hrecht/censusapi
  # https://www.hrecht.com/censusapi/articles/getting-started.html

#census_api_key("1037078fc76765e282541656ed1b89d7cab500c5", install = TRUE)
Sys.getenv("CENSUS_KEY")


#apis <- listCensusApis()
#View(apis)
```

---

## Dataverse


```{r}
# https://guides.dataverse.org/en/latest/user/account.html
  # remotes::install_github("iqss/dataverse-client-r")
  # https://dataverse.harvard.edu/
library(dataverse)

Sys.getenv("DATAVERSE_KEY")
Sys.setenv("DATAVERSE_SERVER" = "dataverse.harvard.edu")

# nlsw <-
#  get_dataframe_by_doi(
#    filedoi     = "10.70122/FK2/PPIAXE/MHDB0O",
#    server      = "demo.dataverse.org")

```


## Quandl

https://www.quandl.com/data/FRED-Federal-Reserve-Economic-Data/documentation


```{r}

real_gdp <- Quandl('FRED/A191RL1Q225SBEA', start_date=start, end_date=end)
cpi <- Quandl('FRED/CPIAUCSL', start_date=start, end_date=end)
unemployment <- Quandl('FRED/UNRATE', start_date=start, end_date=end)
participation <- Quandl('FRED/CIVPART', start_date=start, end_date=end)
real_disposable <- Quandl('FRED/DSPIC96', start_date=start, end_date=end)
nom_disposable <- Quandl('FRED/DSPI', start_date=start, end_date=end)
fed_funds_rate <- Quandl('FRED/DFF', start_date=start, end_date=end)



```

